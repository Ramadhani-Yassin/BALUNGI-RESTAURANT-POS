<?php
session_start(); // Ensure session is started
require_once '../config.php';
include '../inc/dashHeader.php'; 

$bill_id = $_GET['bill_id'];
$staff_id = $_GET['staff_id'];
$member_id = $_GET['member_id'];
$reservation_id = $_GET['reservation_id'];

// Fetch staff members who can authorize compo payments
$staff_query = "SELECT staff_id, staff_name, role FROM staffs WHERE role IN ('Admin', 'Manager')"; // Use the correct table name: staffs
$staff_result = mysqli_query($link, $staff_query);

if (!$staff_result) {
    die("Error fetching staff members: " . mysqli_error($link)); // Debugging: Output the error
}
?>

<style>
    .top-spacer {
        margin-top: 12rem;
        padding-top: 2rem;
    }
</style>

<div class="container-fluid top-spacer">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Compo Payment</h3>
                </div>
                <div class="card-body">
                    <h5>Bill ID: <?php echo $bill_id; ?></h5>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Item ID</th>
                                    <th>Item Name</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php
                                // Query to fetch cart items for the given bill_id from both menu and stock
                                $cart_query = "SELECT bi.*, 
                                                      COALESCE(m.item_name, s.ItemName) AS item_name, 
                                                      COALESCE(m.item_price, 
                                                               CASE WHEN bi.unit = 'base' THEN s.PricePerBaseUnit ELSE s.PricePerSubUnit END) AS item_price
                                               FROM bill_items bi
                                               LEFT JOIN Menu m ON bi.item_id = m.item_id AND bi.source = 'menu'
                                               LEFT JOIN stock s ON bi.item_id = s.ItemID AND bi.source = 'stock'
                                               WHERE bi.bill_id = '$bill_id'";
                                $cart_result = mysqli_query($link, $cart_query);
                                $cart_total = 0;

                                if ($cart_result && mysqli_num_rows($cart_result) > 0) {
                                    while ($cart_row = mysqli_fetch_assoc($cart_result)) {
                                        $item_id = $cart_row['item_id'];
                                        $item_name = $cart_row['item_name'];
                                        $item_price = $cart_row['item_price'];
                                        $quantity = $cart_row['quantity'];
                                        $total = $item_price * $quantity;
                                        $cart_total += $total;
                                        echo '<tr>';
                                        echo '<td>' . $item_id . '</td>';
                                        echo '<td>' . $item_name . '</td>';
                                        echo '<td>TZS ' . number_format($item_price, 2) . '</td>';
                                        echo '<td>' . $quantity . '</td>';
                                        echo '<td>TZS ' . number_format($total, 2) . '</td>';
                                        echo '</tr>';
                                    }
                                } else {
                                    echo '<tr><td colspan="6">No Items in Cart.</td></tr>';
                                }
                                ?>
                            </tbody>
                        </table>
                    </div>
                    <hr>
                    <div class="text-right">
                        <?php 
                        echo "<strong>Total:</strong> TZS " . number_format($cart_total, 2) . "<br>";
                        $GRANDTOTAL = $cart_total; // No tax for compo payments
                        echo "<strong>Grand Total:</strong> TZS " . number_format($GRANDTOTAL, 2);
                        ?>
                    </div>
                    <!-- Staff Selection Form for Compo Authorization -->
                    <div class="text-center mt-4">
                        <form id="compoForm" method="post">
                            <div class="form-group">
                                <label for="staff">Select Authorizing Staff:</label>
                                <select class="form-control" id="staff" name="staff" required>
                                    <option value="">-- Select Staff --</option>
                                    <?php while ($staff = mysqli_fetch_assoc($staff_result)): ?>
                                        <option value="<?= $staff['staff_id'] ?>"><?= $staff['staff_name'] ?> (<?= $staff['role'] ?>)</option>
                                    <?php endwhile; ?>
                                </select>
                            </div><br>
                            <button type="submit" name="pay_done" class="btn btn-dark">Print Receipt ðŸ§¾</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<?php
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['pay_done'])) {
    $authorizing_staff_id = $_POST['staff'];
    $currentTime = date('Y-m-d H:i:s');

    // Update the bill with compo payment information
    $updateQuery = "UPDATE Bills SET payment_method = 'compo', payment_time = '$currentTime',
                    staff_id = $staff_id, member_id = $member_id, reservation_id = $reservation_id,
                    authorizing_staff_id = $authorizing_staff_id WHERE bill_id = $bill_id;";

    if ($link->query($updateQuery) === TRUE) {
        // Log the compo payment (optional)
        $logQuery = "INSERT INTO CompoLogs (bill_id, authorizing_staff_id, amount, compo_time)
                     VALUES ('$bill_id', '$authorizing_staff_id', '$GRANDTOTAL', '$currentTime');";
        $link->query($logQuery);

        // JavaScript for automatic receipt download
        echo '<script>
                setTimeout(function() {
                    window.location.href = "receipt.php?bill_id=' . $bill_id . '";
                }, 1000);
              </script>';
    } else {
        echo "Error updating bill: " . $link->error;
    }
}
?>

<?php include '../inc/dashFooter.php'; ?>






:::::::::::::::::::::::::::::::::::::::::



<?php
session_start(); // Ensure session is started
require_once '../config.php';
include '../inc/dashHeader.php'; 

$bill_id = $_GET['bill_id'];
$staff_id = $_GET['staff_id'];
$member_id = $_GET['member_id'];
$reservation_id = $_GET['reservation_id'];

// Fetch all staff members (no WHERE clause)
$staff_query = "SELECT staff_id, staff_name, role FROM staffs"; // Removed the WHERE clause
$staff_result = mysqli_query($link, $staff_query);

if (!$staff_result) {
    die("Error fetching staff members: " . mysqli_error($link)); // Debugging: Output the error
}
?>

<style>
    .top-spacer {
        margin-top: 12rem;
        padding-top: 2rem;
    }
</style>

<div class="container-fluid top-spacer">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Compo Payment</h3>
                </div>
                <div class="card-body">
                    <h5>Bill ID: <?php echo $bill_id; ?></h5>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Item ID</th>
                                    <th>Item Name</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php
                                // Query to fetch cart items for the given bill_id from both menu and stock
                                $cart_query = "SELECT bi.*, 
                                                      COALESCE(m.item_name, s.ItemName) AS item_name, 
                                                      COALESCE(m.item_price, 
                                                               CASE WHEN bi.unit = 'base' THEN s.PricePerBaseUnit ELSE s.PricePerSubUnit END) AS item_price
                                               FROM bill_items bi
                                               LEFT JOIN Menu m ON bi.item_id = m.item_id AND bi.source = 'menu'
                                               LEFT JOIN stock s ON bi.item_id = s.ItemID AND bi.source = 'stock'
                                               WHERE bi.bill_id = '$bill_id'";
                                $cart_result = mysqli_query($link, $cart_query);
                                $cart_total = 0;

                                if ($cart_result && mysqli_num_rows($cart_result) > 0) {
                                    while ($cart_row = mysqli_fetch_assoc($cart_result)) {
                                        $item_id = $cart_row['item_id'];
                                        $item_name = $cart_row['item_name'];
                                        $item_price = $cart_row['item_price'];
                                        $quantity = $cart_row['quantity'];
                                        $total = $item_price * $quantity;
                                        $cart_total += $total;
                                        echo '<tr>';
                                        echo '<td>' . $item_id . '</td>';
                                        echo '<td>' . $item_name . '</td>';
                                        echo '<td>TZS ' . number_format($item_price, 2) . '</td>';
                                        echo '<td>' . $quantity . '</td>';
                                        echo '<td>TZS ' . number_format($total, 2) . '</td>';
                                        echo '</tr>';
                                    }
                                } else {
                                    echo '<tr><td colspan="6">No Items in Cart.</td></tr>';
                                }
                                ?>
                            </tbody>
                        </table>
                    </div>
                    <hr>
                    <div class="text-right">
                        <?php 
                        echo "<strong>Total:</strong> TZS " . number_format($cart_total, 2) . "<br>";
                        $GRANDTOTAL = $cart_total; // No tax for compo payments
                        echo "<strong>Grand Total:</strong> TZS " . number_format($GRANDTOTAL, 2);
                        ?>
                    </div>
                    <!-- Staff Selection Form for Compo Authorization -->
                    <div class="text-center mt-4">
                        <form id="compoForm" method="post">
                            <div class="form-group">
                                <label for="staff">Select Authorizing Staff:</label>
                                <select class="form-control" id="staff" name="staff" required>
                                    <option value="">-- Select Staff --</option>
                                    <?php while ($staff = mysqli_fetch_assoc($staff_result)): ?>
                                        <option value="<?= $staff['staff_id'] ?>"><?= $staff['staff_name'] ?> (<?= $staff['role'] ?>)</option>
                                    <?php endwhile; ?>
                                </select>
                            </div><br>
                            <button type="submit" name="pay_done" class="btn btn-dark">Print Receipt ðŸ§¾</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<?php
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['pay_done'])) {
    $authorizing_staff_id = $_POST['staff'];
    $currentTime = date('Y-m-d H:i:s');

    // Update the bill with compo payment information
    $updateQuery = "UPDATE Bills SET payment_method = 'compo', payment_time = '$currentTime',
                    staff_id = $staff_id, member_id = $member_id, reservation_id = $reservation_id,
                    authorizing_staff_id = $authorizing_staff_id WHERE bill_id = $bill_id;";

    if ($link->query($updateQuery) === TRUE) {
        // Log the compo payment (optional)
        $logQuery = "INSERT INTO CompoLogs (bill_id, authorizing_staff_id, amount, compo_time)
                     VALUES ('$bill_id', '$authorizing_staff_id', '$GRANDTOTAL', '$currentTime');";
        $link->query($logQuery);

        // JavaScript for automatic receipt download
        echo '<script>
                setTimeout(function() {
                    window.location.href = "receipt.php?bill_id=' . $bill_id . '";
                }, 1000);
              </script>';
    } else {
        echo "Error updating bill: " . $link->error;
    }
}
?>

<?php include '../inc/dashFooter.php'; ?>